{% extends "base.html" %}
{% block title %}Serial Item Transfer {{ transfer.transfer_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-exchange-alt"></i> Serial Item Transfer {{ transfer.transfer_number }}
        </h1>
        <div>
            {% if transfer.status == 'draft' and (transfer.user_id == current_user.id or current_user.role in ['admin', 'manager']) %}
            <button type="button" class="btn btn-success" onclick="submitTransfer()">
                <i class="fas fa-paper-plane"></i> Submit for QC
            </button>
            {% endif %}
            <a href="{{ url_for('serial_item_transfer.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Transfer Status Alert -->
    <div class="row mb-4">
        <div class="col-12">
            {% if transfer.status == 'draft' %}
            <div class="alert alert-secondary">
                <i class="fas fa-edit"></i> This transfer is in <strong>Draft</strong> status. Follow the 5-step process to add items and submit for QC approval.
            </div>
            {% elif transfer.status == 'submitted' %}
            <div class="alert alert-warning">
                <i class="fas fa-clock"></i> This transfer is <strong>Submitted</strong> and waiting for QC approval.
            </div>
            {% elif transfer.status == 'qc_approved' %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> This transfer has been <strong>QC Approved</strong> and is ready for posting.
            </div>
            {% elif transfer.status == 'posted' %}
            <div class="alert alert-primary">
                <i class="fas fa-check-double"></i> This transfer has been <strong>Posted</strong> to SAP B1.
            </div>
            {% elif transfer.status == 'rejected' %}
            <div class="alert alert-danger">
                <i class="fas fa-times-circle"></i> This transfer has been <strong>Rejected</strong>.
                {% if transfer.qc_notes %}
                <br><strong>QC Notes:</strong> {{ transfer.qc_notes }}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Transfer Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 >Document Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <p><strong>Transfer Number:</strong><br>{{ transfer.transfer_number }}</p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Status:</strong><br>
                                {% if transfer.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                                {% elif transfer.status == 'submitted' %}
                                <span class="badge bg-warning">Submitted</span>
                                {% elif transfer.status == 'qc_approved' %}
                                <span class="badge bg-success">QC Approved</span>
                                {% elif transfer.status == 'posted' %}
                                <span class="badge bg-primary">Posted</span>
                                {% elif transfer.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                                {% endif %}
                            </p>
                        </div>
<!--                        {% if transfer.sap_document_number %}-->
<!--                        <div class="col-sm-6">-->
<!--                            <p><strong>SAP Document Number:</strong><br>-->
<!--                                <span class="badge bg-success">{{ transfer.sap_document_number }}</span>-->
<!--                            </p>-->
<!--                        </div>-->
<!--                        {% endif %}-->
<!--                        <div class="col-sm-6">-->
<!--                            <p><strong>From Warehouse:</strong><br>-->
<!--                                <span class="badge bg-info">{{ transfer.from_warehouse }}</span>-->
<!--                            </p>-->
<!--                        </div>-->
<!--                        <div class="col-sm-6">-->
<!--                            <p><strong>To Warehouse:</strong><br>-->
<!--                                <span class="badge bg-info">{{ transfer.to_warehouse }}</span>-->
<!--                            </p>-->
<!--                        </div>-->
                        <div class="col-sm-6">
                            <p><strong>Priority:</strong><br>
                                {% if transfer.priority == 'urgent' %}
                                <span class="badge bg-danger">Urgent</span>
                                {% elif transfer.priority == 'high' %}
                                <span class="badge bg-warning">High</span>
                                {% elif transfer.priority == 'normal' %}
                                <span class="badge bg-info">Normal</span>
                                {% else %}
                                <span class="badge bg-secondary">Low</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Total Items:</strong><br>
                                <span class="badge bg-primary">{{ transfer.items|sum(attribute='quantity') }}</span>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Created By:</strong><br>{{ transfer.user.username }}</p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Created Date:</strong><br>{{ transfer.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        {% if transfer.notes %}
                        <div class="col-12">
                            <p><strong>Notes:</strong><br>{{ transfer.notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 >SAP B1 Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <p><strong>Status:</strong><br>
                                {% if transfer.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                                {% elif transfer.status == 'submitted' %}
                                <span class="badge bg-warning">Submitted</span>
                                {% elif transfer.status == 'qc_approved' %}
                                <span class="badge bg-success">QC Approved</span>
                                {% elif transfer.status == 'posted' %}
                                <span class="badge bg-primary">Posted</span>
                                {% elif transfer.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                                {% endif %}
                            </p>
                        </div>
                        {% if transfer.sap_document_number %}
                        <div class="col-sm-6">
                            <p><strong>SAP Document Number:</strong><br>
                                <span class="badge bg-success">{{ transfer.sap_document_number }}</span>
                            </p>
                        </div>
                        {% endif %}
                        <div class="col-sm-6">
                            <p><strong>From Warehouse:</strong><br>
                                <span class="badge bg-info">{{ transfer.from_warehouse }}</span>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>To Warehouse:</strong><br>
                                <span class="badge bg-info">{{ transfer.to_warehouse }}</span>
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Priority:</strong><br>
                                {% if transfer.priority == 'urgent' %}
                                <span class="badge bg-danger">Urgent</span>
                                {% elif transfer.priority == 'high' %}
                                <span class="badge bg-warning">High</span>
                                {% elif transfer.priority == 'normal' %}
                                <span class="badge bg-info">Normal</span>
                                {% else %}
                                <span class="badge bg-secondary">Low</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Total Items:</strong><br>
                                <span class="badge bg-primary">{{ transfer.items|sum(attribute='quantity') }}</span>
                            </p>
                        </div>
<!--                        <div class="col-sm-6">-->
<!--                            <p><strong>Created By:</strong><br>{{ transfer.user.username }}</p>-->
<!--                        </div>-->
<!--                        <div class="col-sm-6">-->
<!--                            <p><strong>Created Date:</strong><br>{{ transfer.created_at.strftime('%Y-%m-%d %H:%M') }}</p>-->
<!--                        </div>-->
<!--                        {% if transfer.notes %}-->
<!--                        <div class="col-12">-->
<!--                            <p><strong>Notes:</strong><br>{{ transfer.notes }}</p>-->
<!--                        </div>-->
<!--                        {% endif %}-->
                    </div>
                </div>
            </div>
        </div>

<!--        <div class="col-md-6">-->
<!--            <div class="card shadow">-->
<!--                <div class="card-header py-3">-->
<!--                    <h6 class="mb-0 font-weight-bold text-info">5-Step Process Guide</h6>-->
<!--                </div>-->
<!--                <div class="card-body">-->
<!--                    <div class="step-guide">-->
<!--                        <div class="step-item">-->
<!--                            <span class="step-number completed">1</span>-->
<!--                            <span class="step-text">Select Warehouses âœ“</span>-->
<!--                        </div>-->
<!--                        <div class="step-item" id="step2">-->
<!--                            <span class="step-number">2</span>-->
<!--                            <span class="step-text">Select Item</span>-->
<!--                        </div>-->
<!--                        <div class="step-item" id="step3">-->
<!--                            <span class="step-number">3</span>-->
<!--                            <span class="step-text">Enter Quantity & Validate Serials</span>-->
<!--                        </div>-->
<!--                        <div class="step-item" id="step4">-->
<!--                            <span class="step-number">4</span>-->
<!--                            <span class="step-text">Populate Line Items</span>-->
<!--                        </div>-->
<!--                        <div class="step-item" id="step5">-->
<!--                            <span class="step-number">5</span>-->
<!--                            <span class="step-text">Submit Transaction</span>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
    </div>

    <!-- 5-Step Workflow Section -->
    {% if transfer.status == 'draft' and (transfer.user_id == current_user.id or current_user.role in ['admin', 'manager']) %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 >Add Items to Transfer</h6>
                </div>
                <div class="card-body">
                    
                    <!-- Step 2: Select Item -->
                    <div class="step-section" id="stepSection2">
                        <h5 class="text-primary mb-3">
                            <span class="badge bg-primary me-2"></span>Select Item
                        </h5>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="itemSelect" class="form-label">Item Code <span class="text-danger">*</span></label>
                                <select class="form-select" id="itemSelect" onchange="onItemSelected()">
                                    <option value="">Select Item Code...</option>
                                </select>
                                <div class="form-text">Items available in warehouse: {{ transfer.from_warehouse }}</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-primary w-100" onclick="loadItems()">
                                    <i class="fas fa-refresh"></i> Load Items
                                </button>
                            </div>
                        </div>
                        <div id="selectedItemInfo" class="alert alert-info d-none">
                            <strong>Selected Item:</strong> <span id="selectedItemCode"></span> - <span id="selectedItemName"></span>
                        </div>
                    </div>

                    <hr>

                    <!-- Step 3: Enter Quantity & Validate Serial Numbers -->
                    <div class="step-section" id="stepSection3" style="display: none;">
                        <h5 class="text-primary mb-3">
                            <span class="badge bg-primary me-2">3</span>Enter Quantity & Validate Serial Numbers
                        </h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="quantityInput" class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantityInput" min="0" value="0" onchange="onQuantityChanged()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Available Stock</label>
                                <div class="form-control-plaintext" id="onHandQuantityDisplay">
                                    <span id="onHandQuantity" class="badge bg-secondary">Not checked</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-text">
                                    <span id="serialRequiredText" class="d-none">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        This item requires serial number validation. Please enter serial numbers below.
                                    </span>
                                    <span id="serialNotRequiredText" class="d-none">
                                        <i class="fas fa-info-circle text-info"></i>
                                        This item does not require serial numbers. Quantity will be validated against available stock.
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Serial Number Entry Section -->
                        <div id="serialNumberSection" class="d-none">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="serialNumberInput" class="form-label">Serial Number</label>
                                    <input type="text" class="form-control" id="serialNumberInput" placeholder="Enter serial number and press Enter" 
                                           onkeypress="handleSerialInput(event)" onblur="autoValidateSerial()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Progress</label>
                                    <div class="form-control-plaintext">
                                        <span id="serialProgress">0 / 0</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearSerialInput()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>

                            <!-- Validated Serials List -->
                            <div id="validatedSerialsSection" class="d-none">
                                <h6>Validated Serial Numbers</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Serial Number</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="validatedSerialsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="resetItemSelection()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button type="button" class="btn btn-success" id="populateLineItemsBtn" onclick="populateLineItems()" disabled>
                                <i class="fas fa-plus"></i> Populate Line Items
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Step 4: Line Items Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6>
                        <span class="badge bg-primary me-2"></span>Transfer Line Items
                    </h6>
                    <span class="badge bg-info">{{ transfer.items|sum(attribute='quantity') }} item(s)</span>
                </div>
                <div class="card-body">
                    {% if transfer.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Serial Number</th>
                                    <th>Item Code</th>
                                    <th>Item Description</th>
                                    <th>From Warehouse</th>
                                    <th>To Warehouse</th>
                                    <th>Quantity</th>
                                    <th>Validation Status</th>
                                    {% if transfer.status == 'draft' and (transfer.user_id == current_user.id or current_user.role in ['admin', 'manager']) %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in transfer.items %}
                                <tr>
                                    <td>
                                        {% if item.serial_number %}
                                            <span class="font-monospace">{{ item.serial_number }}</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ item.item_code }}</strong></td>
                                    <td>{{ item.item_description }}</td>
                                    <td><span class="badge bg-info">{{ item.from_warehouse_code }}</span></td>
                                    <td><span class="badge bg-success">{{ item.to_warehouse_code }}</span></td>
                                    <td>{{ item.quantity }}</td>
                                    <td>
                                        {% if item.validation_status == 'validated' %}
                                            <span class="badge bg-success">Validated</span>
                                        {% elif item.validation_status == 'failed' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    {% if transfer.status == 'draft' and (transfer.user_id == current_user.id or current_user.role in ['admin', 'manager']) %}
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem('{{ item.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No items added to this transfer yet.</p>
                        {% if transfer.status == 'draft' %}
                        <p class="text-muted">Use the form above to add items following the 5-step process.</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let selectedItem = null;
let validatedSerials = [];
let requiredQuantity = 1;
let currentStep = 2;

$(document).ready(function() {
    // Load items on page load
    loadItems();
    
    // Initialize step display
    updateStepProgress();
});

function loadItems() {
    const warehouseCode = '{{ transfer.from_warehouse }}';
    
    $.ajax({
        url: '/api/get-items-by-warehouse',
        method: 'GET',
        data: { warehouse_code: warehouseCode },
        success: function(response) {
            if (response.success && response.items) {
                const itemSelect = $('#itemSelect');
                itemSelect.find('option:not(:first)').remove();
                
                response.items.forEach(function(item) {
                    const option = $('<option>', {
                        value: item.ItemCode,
                        text: item.ItemCode + ' - ' + item.itemName,
                        'data-item-name': item.itemName
                    });
                    itemSelect.append(option);
                });
                
                showAlert('Items loaded successfully', 'success');
            } else {
                showAlert('Failed to load items', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading items:', error);
            showAlert('Error loading items: ' + error, 'error');
        }
    });
}

function onItemSelected() {
    const itemSelect = $('#itemSelect');
    const selectedOption = itemSelect.find('option:selected');
    
    if (selectedOption.val()) {
        selectedItem = {
            itemCode: selectedOption.val(),
            itemName: selectedOption.data('item-name')
        };
        
        $('#selectedItemCode').text(selectedItem.itemCode);
        $('#selectedItemName').text(selectedItem.itemName);
        $('#selectedItemInfo').removeClass('d-none');
        
        // Move to step 3
        currentStep = 3;
        updateStepProgress();
        $('#stepSection3').show();
        
        // Check if item is serial managed
        checkItemSerialManagement(selectedItem.itemCode);
        
    } else {
        selectedItem = null;
        $('#selectedItemInfo').addClass('d-none');
        $('#stepSection3').hide();
        currentStep = 2;
        updateStepProgress();
    }
}


function showSerialSection(isSerialManaged) {
    if (isSerialManaged) {
        $('#serialRequiredText').removeClass('d-none');
        $('#serialNotRequiredText').addClass('d-none');
        $('#serialNumberSection').removeClass('d-none');
    } else {
        $('#serialRequiredText').addClass('d-none');
        $('#serialNotRequiredText').removeClass('d-none');
        $('#serialNumberSection').addClass('d-none');
    }
}

function updateValidatedSerialsList() {
    const tbody = $('#validatedSerialsTableBody');
    tbody.empty();
    
    if (validatedSerials.length > 0) {
        $('#validatedSerialsSection').removeClass('d-none');
        
        validatedSerials.forEach(function(serial, index) {
            const row = $('<tr>');
            const serialCell = $('<td>').append($('<span class="font-monospace">').text(serial.serialNumber));
            const statusCell = $('<td>').append($('<span class="badge bg-success">').text('Validated'));
            const actionCell = $('<td>').append(
                $('<button type="button" class="btn btn-sm btn-outline-danger">')
                .attr('onclick', `removeValidatedSerial(${index})`)
                .append($('<i class="fas fa-trash">'))
            );
            row.append(serialCell).append(statusCell).append(actionCell);
            tbody.append(row);
        });
    } else {
        $('#validatedSerialsSection').addClass('d-none');
    }
}

function removeValidatedSerial(index) {
    validatedSerials.splice(index, 1);
    updateValidatedSerialsList();
    updateSerialProgress();
    updatePopulateButton();
}

function updateSerialProgress() {
    $('#serialProgress').text(validatedSerials.length + ' / ' + requiredQuantity);
}

function updatePopulateButton() {
    let canPopulate = false;
    
    if (selectedItem) {
        if ($('#serialNumberSection').is(':visible')) {
            // Serial managed item
            canPopulate = validatedSerials.length >= requiredQuantity;
        } else {
            // Non-serial item
            canPopulate = requiredQuantity > 0;
        }
    }
    
    $('#populateLineItemsBtn').prop('disabled', !canPopulate);
}

function populateLineItems() {
    if (!selectedItem) {
        showAlert('Please select an item first', 'error');
        return;
    }
    
    // Handle serial managed items
    if ($('#serialNumberSection').is(':visible')) {
        if (validatedSerials.length < requiredQuantity) {
            showAlert('Please validate all required serial numbers first', 'error');
            return;
        }
        
        // Create line items based on validated serials
        const promises = validatedSerials.map(function(serial) {
            return $.ajax({
                url: '/serial-item-transfer/{{ transfer.id }}/add_serial_item',
                method: 'POST',
                data: {
                    serial_number: serial.serialNumber,
                    expected_item_code: selectedItem.itemCode
                }
            });
        });
        
        Promise.all(promises)
            .then(function(responses) {
                const successCount = responses.filter(r => r.success).length;
                if (successCount === validatedSerials.length) {
                    showAlert(`Successfully added ${successCount} serial line items`, 'success');
                    // Refresh page to show new items
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(`Added ${successCount} of ${validatedSerials.length} items. Some items failed.`, 'warning');
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                }
            })
            .catch(function(error) {
                console.error('Error populating line items:', error);
                showAlert('Error adding line items', 'error');
            });
    } else {
        // Handle non-serial items
        $.ajax({
            url: '/serial-item-transfer/{{ transfer.id }}/add_non_serial_item',
            method: 'POST',
            data: {
                item_code: selectedItem.itemCode,
                item_description: selectedItem.itemName,
                quantity: requiredQuantity,
                unit_of_measure: 'EA'
            },
            success: function(response) {
                if (response.success) {
                    showAlert(`Successfully added ${requiredQuantity} quantity of ${selectedItem.itemCode}`, 'success');
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(response.error || 'Error adding non-serial item', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error adding non-serial item:', error);
                showAlert('Error adding non-serial item', 'error');
            }
        });
    }
}

function resetItemSelection() {
    selectedItem = null;
    validatedSerials = [];
    requiredQuantity = 1;
    currentStep = 2;
    
    $('#itemSelect').val('');
    $('#quantityInput').val('1');
    $('#serialNumberInput').val('');
    $('#selectedItemInfo').addClass('d-none');
    $('#stepSection3').hide();
    $('#validatedSerialsSection').addClass('d-none');
    
    updateStepProgress();
    updatePopulateButton();
}

function updateStepProgress() {
    // Reset all steps
    $('.step-item').removeClass('completed current');
    $('.step-number').removeClass('completed');
    
    // Mark completed steps
    for (let i = 1; i <= Math.min(currentStep - 1, 5); i++) {
        $(`#step${i}, .step-item:nth-child(${i})`).addClass('completed');
        $(`#step${i} .step-number, .step-item:nth-child(${i}) .step-number`).addClass('completed');
    }
    
    // Mark current step
    if (currentStep <= 5) {
        $(`#step${currentStep}, .step-item:nth-child(${currentStep})`).addClass('current');
    }
}

function removeItem(itemId) {
    if (confirm('Are you sure you want to remove this item?')) {
        $.ajax({
            url: `/serial-item-transfer/items/${itemId}/delete`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showAlert('Item removed successfully', 'success');
                    location.reload();
                } else {
                    showAlert(response.error || 'Error removing item', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error removing item:', error);
                showAlert('Error removing item', 'error');
            }
        });
    }
}

function submitTransfer() {
    if (confirm('Are you sure you want to submit this transfer for QC approval?')) {
        $.ajax({
            url: '/serial-item-transfer/{{ transfer.id }}/submit',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showAlert('Transfer submitted successfully!', 'success');
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(response.error || 'Error submitting transfer', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error submitting transfer:', error);
                showAlert('Error submitting transfer', 'error');
            }
        });
    }
}

function showAlert(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    // Create alert element safely to prevent XSS
    const alert = $('<div class="alert alert-dismissible fade show" role="alert">')
        .addClass(alertClass)
        .text(message)  // Use .text() to safely insert user content
        .append($('<button type="button" class="btn-close" data-bs-dismiss="alert">'));
    
    $('.container-fluid').prepend(alert);
    
    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        alert.alert('close');
    }, 5000);
}

// New functions for improved workflow

function displayOnHandQuantity(quantity) {
    const badge = $('#onHandQuantity');
    const quantityInput = $('#quantityInput');
    
    if (quantity > 0) {
        badge.removeClass('bg-secondary bg-danger').addClass('bg-success');
        badge.text(`${quantity} available`);
        
        // Update quantity input max value
        quantityInput.attr('max', quantity);
        
        // If current quantity exceeds available, adjust it
        const currentQuantity = parseInt(quantityInput.val()) || 1;
        if (currentQuantity > quantity) {
            quantityInput.val(quantity);
            showAlert(`Quantity adjusted to available stock: ${quantity}`, 'warning');
        }
    } else {
        badge.removeClass('bg-secondary bg-success').addClass('bg-danger');
        badge.text('No stock available');
        
        // Disable quantity input if no stock
        quantityInput.attr('max', 0);
        quantityInput.val(0);
        showAlert('No stock available for this item in the selected warehouse', 'error');
    }
}


function onItemSelected() {
    const itemSelect = $('#itemSelect');
    const selectedValue = itemSelect.val();
    
    if (!selectedValue) {
        // No item selected, reset everything
        selectedItem = null;
        $('#selectedItemInfo').addClass('d-none');
        $('#stepSection3').hide();
        $('#onHandQuantity').removeClass('bg-success bg-danger').addClass('bg-secondary').text('Not checked');
        updateStepProgress();
        return;
    }
    
    // Find the selected item from the loaded items
    const option = itemSelect.find(':selected');
    const itemCode = selectedValue;
    const itemName = option.text().replace(itemCode + ' - ', '');
    
    // Update selectedItem global variable
    selectedItem = {
        itemCode: itemCode,
        itemName: itemName
    };
    
    // Show selected item info
    $('#selectedItemCode').text(itemCode);
    $('#selectedItemName').text(itemName);
    $('#selectedItemInfo').removeClass('d-none');
    
    // Show step 3 section
    $('#stepSection3').show();
    currentStep = 3;
    updateStepProgress();
    
    // Call the new SAP B1 API to check item requirements
    checkItemSerialManagement(itemCode);
}

function onQuantityChanged() {
    const quantityInput = $('#quantityInput');
    const quantity = parseInt(quantityInput.val()) || 1;
    
    // Update global variable
    requiredQuantity = quantity;
    
    // Update serial progress if serial section is visible
    if ($('#serialNumberSection').is(':visible')) {
        updateSerialProgress();
    }
    
    // Update populate button state
    updatePopulateButton();
    
    // Check if quantity exceeds max allowed (based on OnHand)
    const maxQuantity = parseInt(quantityInput.attr('max'));
    if (maxQuantity && quantity > maxQuantity) {
        showAlert(`Quantity (${quantity}) exceeds available stock (${maxQuantity})`, 'warning');
        quantityInput.val(maxQuantity);
        requiredQuantity = maxQuantity;
    }
    
    // For non-serial items with auto-populate, update the auto-populate condition
    if (selectedItem && selectedItem.manSerNum === 'N' && selectedItem.onHandQuantity) {
        const onHandQuantity = selectedItem.onHandQuantity;
        if (quantity <= onHandQuantity) {
            // Could auto-populate again if needed, but usually not necessary
            // Just ensure the populate button is enabled
            updatePopulateButton();
        }
    }
}

function handleSerialInput(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        autoValidateSerial();
    }
}

function autoValidateSerial() {
    const serialNumber = $('#serialNumberInput').val().trim();
    if (serialNumber) {
        validateSerialAndAutoPopulate();
    }
}

function validateSerialAndAutoPopulate() {
    const serialNumber = $('#serialNumberInput').val().trim();
    
    if (!serialNumber) {
        showAlert('Please enter a serial number', 'error');
        return;
    }
    
    if (!selectedItem) {
        showAlert('Please select an item first', 'error');
        return;
    }
    
    // Enhanced duplicate check with case-insensitive comparison
    const existingSerial = validatedSerials.find(s => s.serialNumber.toLowerCase() === serialNumber.toLowerCase());
    if (existingSerial) {
        showAlert(`Serial number "${serialNumber}" has already been validated. Please enter a different serial number.`, 'warning');
        $('#serialNumberInput').val('').focus();
        return;
    }
    
    // Check if we already have enough serials
    if (validatedSerials.length >= requiredQuantity) {
        showAlert(`You have already validated ${requiredQuantity} serial numbers. Remove existing serials if you need to add different ones.`, 'warning');
        $('#serialNumberInput').val('');
        return;
    }
    
    const data = {
        warehouse_code: '{{ transfer.from_warehouse }}',
        serial_number: serialNumber,
        item_code: selectedItem.itemCode
    };
    
    // Show loading state
    $('#serialNumberInput').prop('disabled', true);
    
    $.ajax({
        url: '/api/validate-serial-number',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            $('#serialNumberInput').prop('disabled', false);
            
            if (response.success && response.valid) {
                // Add to validated serials
                validatedSerials.push({
                    serialNumber: serialNumber,
                    itemCode: selectedItem.itemCode,
                    status: 'validated'
                });
                
                // Clear input and focus for next entry
                $('#serialNumberInput').val('').focus();
                
                // Update UI
                updateValidatedSerialsList();
                updateSerialProgress();
                updatePopulateButton();
                
                showAlert(`Serial number "${serialNumber}" validated successfully`, 'success');
                
                // If we have enough serials, notify user
                if (validatedSerials.length >= requiredQuantity) {
                    showAlert('All required serial numbers validated! You can now populate line items.', 'success');
                    $('#populateLineItemsBtn').focus(); // Focus the populate button
                }
                
            } else {
                showAlert(response.error || 'Serial number validation failed', 'error');
                $('#serialNumberInput').focus();
            }
        },
        error: function(xhr, status, error) {
            $('#serialNumberInput').prop('disabled', false);
            console.error('Error validating serial:', error);
            showAlert('Error validating serial number: ' + error, 'error');
            $('#serialNumberInput').focus();
        }
    });
}

function clearSerialInput() {
    $('#serialNumberInput').val('').focus();
}

function checkItemSerialManagement(itemCode) {
    if (!itemCode) {
        return;
    }
    
    // Show loading state
    showAlert('Checking item requirements...', 'info');
    
    // Call the new SAP B1 API to get actual ManSerNum flag and OnHand quantity
    const data = {
        warehouse_code: '{{ transfer.from_warehouse }}',
        item_code: itemCode
    };
    
    $.ajax({
        url: '/serial-item-transfer/api/check-item-quantity',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                const itemData = response.data;
                const isSerialManaged = itemData.ManSerNum === 'Y';
                const onHandQuantity = itemData.OnHand || 0;
                
                // Display OnHand quantity in the UI
                displayOnHandQuantity(onHandQuantity);
                
                if (isSerialManaged) {
                    showSerialSection(true);
                    showAlert(`Item ${itemCode} requires serial number validation. OnHand: ${onHandQuantity}`, 'info');
                } else {
                    showSerialSection(false);
                    showAlert(`Item ${itemCode} does not require serial numbers. OnHand: ${onHandQuantity}`, 'info');
                    // Set quantity to 1 for non-serial items and enable manual populate button
                    $('#quantityInput').val(1);
                    onQuantityChanged();
                    updatePopulateButton();
                }
                
                // Store the item management info for later use
                if (selectedItem) {
                    selectedItem.isSerialManaged = isSerialManaged;
                    selectedItem.onHandQuantity = onHandQuantity;
                    selectedItem.manSerNum = itemData.ManSerNum;
                }
            } else {
                // Handle API error - show warning but allow fallback
                const errorMsg = response.error || 'Failed to check item requirements';
                showAlert(`Warning: ${errorMsg}. Using fallback item detection.`, 'warning');
                
                // Fallback to heuristic approach
                const isSerialManaged = itemCode.startsWith('S') || itemCode.includes('Serial');
                if (isSerialManaged) {
                    showSerialSection(true);
                    showAlert(`Item ${itemCode} requires serial number validation (fallback detection)`, 'info');
                } else {
                    showSerialSection(false);
                    showAlert(`Item ${itemCode} does not require serial numbers (fallback detection)`, 'info');
                    updatePopulateButton();
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error checking item serial management:', error);
            showAlert(`Error checking item requirements: ${error}. Using fallback item detection.`, 'warning');
            
            // Fallback to heuristic approach
            const isSerialManaged = itemCode.startsWith('S') || itemCode.includes('Serial');
            if (isSerialManaged) {
                showSerialSection(true);
                showAlert(`Item ${itemCode} requires serial number validation (fallback detection)`, 'info');
            } else {
                showSerialSection(false);
                showAlert(`Item ${itemCode} does not require serial numbers (fallback detection)`, 'info');
                updatePopulateButton();
            }
        }
    });
}

function validateSerial() {
    const serialNumber = $('#serialNumberInput').val().trim();
    
    if (!serialNumber) {
        showAlert('Please enter a serial number', 'error');
        return;
    }
    
    if (!selectedItem) {
        showAlert('Please select an item first', 'error');
        return;
    }
    
    // Enhanced duplicate check with better user feedback
    const existingSerial = validatedSerials.find(s => s.serialNumber.toLowerCase() === serialNumber.toLowerCase());
    if (existingSerial) {
        showAlert(`Serial number "${serialNumber}" has already been validated. Please enter a different serial number.`, 'warning');
        $('#serialNumberInput').val('').focus();
        return;
    }
    
    // Check if we already have enough serials
    if (validatedSerials.length >= requiredQuantity) {
        showAlert(`You have already validated ${requiredQuantity} serial numbers. Remove existing serials if you need to add different ones.`, 'warning');
        $('#serialNumberInput').val('');
        return;
    }
    
    const data = {
        warehouse_code: '{{ transfer.from_warehouse }}',
        serial_number: serialNumber,
        item_code: selectedItem.itemCode
    };
    
    // Show loading state
    $('#serialNumberInput').prop('disabled', true);
    
    $.ajax({
        url: '/api/validate-serial-number',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            $('#serialNumberInput').prop('disabled', false);
            
            if (response.success && response.valid) {
                // Add to validated serials
                validatedSerials.push({
                    serialNumber: serialNumber,
                    itemCode: selectedItem.itemCode,
                    status: 'validated'
                });
                
                // Clear input and focus for next entry
                $('#serialNumberInput').val('').focus();
                
                // Update UI
                updateValidatedSerialsList();
                updateSerialProgress();
                updatePopulateButton();
                
                showAlert(`Serial number "${serialNumber}" validated successfully`, 'success');
                
                // If we have enough serials, notify user
                if (validatedSerials.length >= requiredQuantity) {
                    showAlert('All required serial numbers validated! You can now populate line items.', 'success');
                    $('#populateLineItemsBtn').focus(); // Focus the populate button
                }
                
            } else {
                showAlert(response.error || 'Serial number validation failed', 'error');
                $('#serialNumberInput').focus();
            }
        },
        error: function(xhr, status, error) {
            $('#serialNumberInput').prop('disabled', false);
            console.error('Error validating serial:', error);
            showAlert('Error validating serial number: ' + error, 'error');
            $('#serialNumberInput').focus();
        }
    });
}

function updatePopulateButton() {
    let canPopulate = false;
    
    if (selectedItem) {
        if ($('#serialNumberSection').is(':visible')) {
            // Serial managed item
            canPopulate = validatedSerials.length >= requiredQuantity;
        } else {
            // Non-serial item
            canPopulate = requiredQuantity > 0;
        }
    }
    
    $('#populateLineItemsBtn').prop('disabled', !canPopulate);
}

function populateLineItems() {
    if (!selectedItem) {
        showAlert('Please select an item first', 'error');
        return;
    }
    
    // Handle serial managed items
    if ($('#serialNumberSection').is(':visible')) {
        if (validatedSerials.length < requiredQuantity) {
            showAlert('Please validate all required serial numbers first', 'error');
            return;
        }
        
        // Create line items based on validated serials
        const promises = validatedSerials.map(function(serial) {
            return $.ajax({
                url: '/serial-item-transfer/{{ transfer.id }}/add_serial_item',
                method: 'POST',
                data: {
                    serial_number: serial.serialNumber,
                    expected_item_code: selectedItem.itemCode
                }
            });
        });
        
        Promise.all(promises)
            .then(function(responses) {
                const successCount = responses.filter(r => r.success).length;
                if (successCount === validatedSerials.length) {
                    showAlert(`Successfully added ${successCount} serial line items`, 'success');
                    // Refresh page to show new items
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(`Added ${successCount} of ${validatedSerials.length} items. Some items failed.`, 'warning');
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                }
            })
            .catch(function(error) {
                console.error('Error populating line items:', error);
                showAlert('Error adding line items', 'error');
            });
    } else {
        // Handle non-serial items
        $.ajax({
            url: '/serial-item-transfer/{{ transfer.id }}/add_non_serial_item',
            method: 'POST',
            data: {
                item_code: selectedItem.itemCode,
                item_description: selectedItem.itemName,
                quantity: requiredQuantity,
                unit_of_measure: 'EA'
            },
            success: function(response) {
                if (response.success) {
                    showAlert(`Successfully added ${requiredQuantity} quantity of ${selectedItem.itemCode}`, 'success');
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(response.error || 'Error adding non-serial item', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error adding non-serial item:', error);
                showAlert('Error adding non-serial item', 'error');
            }
        });
    }
}

// Missing function implementations to fix frontend wiring issues

function updateStepProgress() {
    // Update step progress indicators - this could be enhanced with actual visual indicators
    console.log(`Current step: ${currentStep}`);
}

function resetItemSelection() {
    selectedItem = null;
    validatedSerials = [];
    requiredQuantity = 1;
    currentStep = 2;
    
    // Reset UI elements
    $('#itemSelect').val('');
    $('#selectedItemInfo').addClass('d-none');
    $('#stepSection3').hide();
    $('#quantityInput').val(1);
    $('#serialNumberInput').val('');
    $('#onHandQuantity').text('Not checked').removeClass().addClass('badge bg-secondary');
    $('#serialNumberSection').addClass('d-none');
    $('#validatedSerialsSection').addClass('d-none');
    $('#populateLineItemsBtn').prop('disabled', true);
    
    updateStepProgress();
    showAlert('Item selection reset', 'info');
}

function updateSerialProgress() {
    const progress = `${validatedSerials.length} / ${requiredQuantity}`;
    $('#serialProgress').text(progress);
}

function updateValidatedSerialsList() {
    const tbody = $('#validatedSerialsTableBody');
    tbody.empty();
    
    if (validatedSerials.length > 0) {
        $('#validatedSerialsSection').removeClass('d-none');
        
        validatedSerials.forEach(function(serial, index) {
            const row = $('<tr>');
            const serialCell = $('<td>').append($('<span class="font-monospace">').text(serial.serialNumber));
            const statusCell = $('<td>').append($('<span class="badge bg-success">').text('Validated'));
            const actionCell = $('<td>').append(
                $('<button type="button" class="btn btn-sm btn-outline-danger">')
                .attr('onclick', `removeValidatedSerial(${index})`)
                .append($('<i class="fas fa-trash">'))
            );
            row.append(serialCell).append(statusCell).append(actionCell);
            tbody.append(row);
        });
    } else {
        $('#validatedSerialsSection').addClass('d-none');
    }
}

function removeValidatedSerial(index) {
    if (index >= 0 && index < validatedSerials.length) {
        const removed = validatedSerials.splice(index, 1);
        updateValidatedSerialsList();
        updateSerialProgress();
        updatePopulateButton();
        showAlert(`Removed serial number "${removed[0].serialNumber}"`, 'info');
        $('#serialNumberInput').focus();
    }
}

function displayOnHandQuantity(quantity) {
    const badge = $('#onHandQuantity');
    badge.text(quantity);
    
    // Update badge color based on quantity
    badge.removeClass().addClass('badge');
    if (quantity > 10) {
        badge.addClass('bg-success');
    } else if (quantity > 0) {
        badge.addClass('bg-warning');
    } else {
        badge.addClass('bg-danger');
    }
}



function submitTransfer() {
    if (!confirm('Are you sure you want to submit this transfer for QC approval?')) {
        return;
    }
    
    $.ajax({
        url: '/serial-item-transfer/{{ transfer.id }}/submit',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert('Transfer submitted for QC approval successfully', 'success');
                setTimeout(function() {
                    location.reload();
                }, 1500);
            } else {
                showAlert(response.error || 'Error submitting transfer', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error submitting transfer:', error);
            showAlert('Error submitting transfer', 'error');
        }
    });
}

function showAlert(message, type) {
    // Create or get alert container
    let alertContainer = $('#alertContainer');
    if (alertContainer.length === 0) {
        alertContainer = $('<div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;"></div>');
        $('body').append(alertContainer);
    }
    
    // Map alert types to Bootstrap classes
    const alertClasses = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const alertClass = alertClasses[type] || 'alert-info';
    
    // Create alert element
    const alertId = 'alert-' + Date.now();
    const alertElement = $(`
        <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `);
    
    // Add to container
    alertContainer.append(alertElement);
    
    // Auto-remove after 5 seconds (except for errors which stay longer)
    const timeout = type === 'error' ? 8000 : 5000;
    setTimeout(function() {
        $(`#${alertId}`).fadeOut(function() {
            $(this).remove();
        });
    }, timeout);
    
    // Also log to console for debugging
    console.log(`${type.toUpperCase()}: ${message}`);
}

</script>

<style>
.step-guide {
    padding: 1rem 0;
}

.step-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

.step-item.current {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.step-item.completed {
    background-color: #e8f5e8;
    border-left: 4px solid #4caf50;
}

.step-number {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background-color: #e0e0e0;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.step-number.completed {
    background-color: #4caf50;
    color: white;
}

.step-item.current .step-number {
    background-color: #2196f3;
    color: white;
}

.step-text {
    font-weight: 500;
    color: #333;
}

.step-item.completed .step-text {
    color: #2e7d32;
}

.step-item.current .step-text {
    color: #1976d2;
    font-weight: 600;
}

.step-section {
    border: 1px solid #e0e0e0;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background-color: #fafafa;
}

.step-section h5 {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #ddd;
}
</style>
{% endblock %}